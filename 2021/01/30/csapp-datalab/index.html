<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"gonggongjohn.me","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Data Lab要求我们在有一系列运算限制的情况下实现某些运算操作，从而尽可能的开发位运算的作用。这个Lab中的绝大部分内容的技巧性都比较强，可以阅读《算法心得：高效算法的奥秘》一书作为参考。">
<meta property="og:type" content="article">
<meta property="og:title" content="Data Lab实验记录">
<meta property="og:url" content="http://gonggongjohn.me/2021/01/30/csapp-datalab/index.html">
<meta property="og:site_name" content="GONGGONGJOHN&#39;s Blog">
<meta property="og:description" content="Data Lab要求我们在有一系列运算限制的情况下实现某些运算操作，从而尽可能的开发位运算的作用。这个Lab中的绝大部分内容的技巧性都比较强，可以阅读《算法心得：高效算法的奥秘》一书作为参考。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-01-30T14:15:21.000Z">
<meta property="article:modified_time" content="2021-02-01T06:30:16.415Z">
<meta property="article:author" content="GONGGONGJOHN">
<meta property="article:tag" content="Computer-Science">
<meta property="article:tag" content="Computer-System">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://gonggongjohn.me/2021/01/30/csapp-datalab/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Data Lab实验记录 | GONGGONGJOHN's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="GONGGONGJOHN's Blog" type="application/atom+xml">
</head>



<script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>



<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">GONGGONGJOHN's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">4</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">14</span></a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://gonggongjohn.me/2021/01/30/csapp-datalab/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="GONGGONGJOHN">
      <meta itemprop="description" content="A sophomore student major in Data Science.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GONGGONGJOHN's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Data Lab实验记录
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-01-30 22:15:21" itemprop="dateCreated datePublished" datetime="2021-01-30T22:15:21+08:00">2021-01-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-02-01 14:30:16" itemprop="dateModified" datetime="2021-02-01T14:30:16+08:00">2021-02-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index"><span itemprop="name">计算机系统</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>Data Lab要求我们在有一系列运算限制的情况下实现某些运算操作，从而尽可能的开发位运算的作用。这个Lab中的绝大部分内容的技巧性都比较强，可以阅读<strong>《算法心得：高效算法的奥秘》</strong>一书作为参考。</p>
<a id="more"></a>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>在Lab中的<strong>bits.c</strong>文件内描述了一系列规则和我们需要实现的函数。具体来说，我们需要实现以下几个函数：</p>
<ul>
<li><strong>bitAnd</strong>：按位与</li>
<li><strong>getByte</strong>：从一个二进制整数中提取某个Byte（8位）</li>
<li><strong>logicalShift</strong>：逻辑右移</li>
<li><strong>bitCount</strong>：计算一个二进制整数中1的位数</li>
<li><strong>bang</strong>：逻辑取反</li>
<li><strong>tmin</strong>：最小的补码能表示的int型整数</li>
<li><strong>fitsBits</strong>：判断某个整数能否用n位补码表示</li>
<li><strong>divpwr2</strong>：计算 <script type="math/tex">\frac{x}{2^n}</script> 并向0取整</li>
<li><strong>negate</strong>：取相反数</li>
<li><strong>isPositive</strong>：判断某个数是否为正数</li>
<li><strong>isLessOrEqual</strong>：判断x是否小于等于y</li>
<li><strong>ilog2</strong>：计算 <script type="math/tex">\lfloor \log_2 x \rfloor</script></li>
<li><strong>float_neg</strong>：在float型表示下取相反数</li>
<li><strong>float_i2f</strong>：将int型表示转为float型表示</li>
<li><strong>float_twice</strong>：在float型表示下计算 <script type="math/tex">2*x</script></li>
</ul>
<p>对于上面这些函数，我们一般只能使用以下几种运算操作：</p>
<p><strong>逻辑取反（!），按位取反（~），按位与（&amp;），按位异或（^），按位或（|），加法（+），左移（&lt;&lt;），算数右移（&gt;&gt;）</strong></p>
<p>在此基础之上，其中某些函数还有进一步的限制要求：</p>
<ul>
<li>bitAnd：只允许使用<strong>按位取反（~）</strong>和<strong>按位或（|）</strong>操作</li>
<li>bang：不允许使用<strong>逻辑取反（!）</strong>操作</li>
<li>float_neg/float_i2f/float_twice：允许使用一切<strong>整数操作</strong>、<strong>逻辑与（&amp;&amp;）</strong>、<strong>逻辑或（||）</strong>、<strong>if语句</strong>及<strong>while语句</strong></li>
</ul>
<p>Lab中提供了两种工具来帮助我们检查实现是否正确：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> ./dlc -e bits.c <span class="comment"># 检查函数实现中操作是否符合要求</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ./driver.pl <span class="comment"># 检查函数实现是否正确</span></span></span><br></pre></td></tr></table></figure>
<h2 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h2><h3 id="bitAnd"><a href="#bitAnd" class="headerlink" title="bitAnd"></a>bitAnd</h3><p>由<strong>De Morgan律</strong>可知 <script type="math/tex">\neg (P \land Q) = (\neg P) \lor (\neg Q)</script></p>
<p>故 <script type="math/tex">P \land Q = \neg ((\neg P) \lor (\neg Q))</script></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bitAnd</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> ~(~x | ~y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一行代码搞定。</p>
<h3 id="getByte"><a href="#getByte" class="headerlink" title="getByte"></a>getByte</h3><p>采用掩码的思想，要提取某个Byte的数值并屏蔽其他位的值，可以将目标位移动到最小的8位并将其和0xFF做按位与运算。观察输入的参数，要提取 <script type="math/tex">x</script> 中的第 <script type="math/tex">n</script> 个Byte，就要将 <script type="math/tex">x</script> 向右移动 <script type="math/tex">8*n</script> 位。使用位运算操作的话，也即x&gt;&gt;(n&lt;&lt;3)。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getByte</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (x&gt;&gt;(n&lt;&lt;<span class="number">3</span>)) &amp; <span class="number">0xFF</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同样可以一行搞定。</p>
<h3 id="logicalShift"><a href="#logicalShift" class="headerlink" title="logicalShift"></a>logicalShift</h3><p>算数右移和逻辑右移的区别在于，算数右移会在高位填充最高位的值，而逻辑右移则不会，因此一个基本的思路就是使用算数右移后屏蔽掉高位的值，于是问题便转化为如何构造掩码。</p>
<p>我们的掩码要保证原数最高位之前均为0，最高位之后均为1。而利用算数右移会填充最高位的特性，我们可以将0x1移动到最高位，随后算数右移到目标位置，再取反即可满足要求，问题也迎刃而解。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">logicalShift</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (x&gt;&gt;n)&amp;(~((<span class="number">0x01</span>&lt;&lt;<span class="number">31</span>)&gt;&gt;n&lt;&lt;<span class="number">1</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="bitCount"><a href="#bitCount" class="headerlink" title="bitCount"></a>bitCount</h3><p>利用位运算统计一个字中1的个数是一个技巧性十分强的算法。它的主要思想是<strong>分治法（Divide And Conquer）</strong>，将统计整个字中1的个数的问题转化为多个统计更小区间内1的个数的问题。具体来说，一个32位的整数中，我们可以将其划分为两个16位的区间，进而划分为4个8位的区间，再划分为8个4位的区间，最后划分为16个2位的区间，因此我们仅需要统计每两位中1的个数，再将结果逐步合并即可得到整个数中1的个数。</p>
<p>对于统计每2位中1的个数，我们同样可以采用掩码的思想，先对两位中第一位和0x1做与运算，再将整个数右移一位与0x1做与运算，将两个结果相加即可统计出这两位中1的个数。</p>
<p>此外，由于题目中规定不能使用超过0xFF的十六进制数，我们需要通过多步位移的方法来构造出我们想要的的掩码。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bitCount</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> cnt;</span><br><span class="line">	<span class="keyword">int</span> maskt1 = (<span class="number">0x55</span>) | (<span class="number">0x55</span>&lt;&lt;<span class="number">8</span>);</span><br><span class="line">	<span class="keyword">int</span> maskt2 = (<span class="number">0x33</span>) | (<span class="number">0x33</span>&lt;&lt;<span class="number">8</span>);</span><br><span class="line">	<span class="keyword">int</span> maskt3 = (<span class="number">0x0F</span>) | (<span class="number">0x0F</span>&lt;&lt;<span class="number">8</span>);</span><br><span class="line">	<span class="keyword">int</span> mask1 = (maskt1) | (maskt1&lt;&lt;<span class="number">16</span>);</span><br><span class="line">	<span class="keyword">int</span> mask2 = (maskt2) | (maskt2&lt;&lt;<span class="number">16</span>);</span><br><span class="line">	<span class="keyword">int</span> mask3 = (maskt3) | (maskt3&lt;&lt;<span class="number">16</span>);</span><br><span class="line">	<span class="keyword">int</span> mask4 = (<span class="number">0xFF</span>) | (<span class="number">0xFF</span>&lt;&lt;<span class="number">16</span>);</span><br><span class="line">	<span class="keyword">int</span> mask5 = (<span class="number">0xFF</span>) | (<span class="number">0xFF</span>&lt;&lt;<span class="number">8</span>);</span><br><span class="line">	cnt = (x &amp; mask1) + ((x&gt;&gt;<span class="number">1</span>) &amp; mask1);</span><br><span class="line">	cnt = (cnt &amp; mask2) + ((cnt&gt;&gt;<span class="number">2</span>) &amp; mask2);</span><br><span class="line">	cnt = (cnt &amp; mask3) + ((cnt&gt;&gt;<span class="number">4</span>) &amp; mask3);</span><br><span class="line">	cnt = (cnt &amp; mask4) + ((cnt&gt;&gt;<span class="number">8</span>) &amp; mask4);</span><br><span class="line">	cnt = (cnt &amp; mask5) + ((cnt&gt;&gt;<span class="number">16</span>) &amp; mask5);</span><br><span class="line">	<span class="keyword">return</span> cnt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="negate"><a href="#negate" class="headerlink" title="negate"></a>negate</h3><p>在补码表示中，对一个二进制表示下 <script type="math/tex">n</script> 位的整数 <script type="math/tex">x</script> 取相反数相当于做运算 <script type="math/tex">2^n-x</script>，而 <script type="math/tex">(2^n-1)-x</script> 相当于对x按位取反，因此总的位运算表示即为~x+1</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">negate</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> ~x+<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="bang"><a href="#bang" class="headerlink" title="bang"></a>bang</h3><p>逻辑取反操作即是要让0变为1，除0以外的任何数变为0，因此我们需要找到一个把0和其他数分开的位运算特性。利用补码表示中负数的最高位始终为1的特性，我们可以发现让一个数和它在补码下的相反数做按位或运算时，如果这个数不为0，那么它的最高位始终为1，而由于0的补码还是0，因此最高位为0。于是利用上一题的结论，我们就能得到最终的运算操作。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bang</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> ((x|(~x+<span class="number">1</span>))&gt;&gt;<span class="number">31</span>)+<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="tmin"><a href="#tmin" class="headerlink" title="tmin"></a>tmin</h3><p>在模的剩余系下，最靠近中间的数即为离边界距离最远的数。利用这一特性可知补码表示下最小的负数最高位为1，其余全为0。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">tmin</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0x1</span>&lt;&lt;<span class="number">31</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="fitsBits"><a href="#fitsBits" class="headerlink" title="fitsBits"></a>fitsBits</h3><p>如果一个数能用n为补码表示，那么取它的后n位做符号扩展到原来的长度后值应与原来一样。利用逻辑右移的特性，我们只需要将x与x&lt;&lt;(32 - n)&gt;&gt;(32 - n)相比较即可。利用位运算取相反数的结论，以及异或运算的性质 <script type="math/tex">x \oplus x = 0</script>，即可得到最终的运算操作。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fitsBits</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> shift = <span class="number">32</span> + ~n + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> !(x^((x&lt;&lt;shift)&gt;&gt;shift));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="divpwr2"><a href="#divpwr2" class="headerlink" title="divpwr2"></a>divpwr2</h3><p>要计算 <script type="math/tex">\frac{x}{2^n}</script> 并向0取整，因此我们需要分类讨论。当 <script type="math/tex">x \geq 0</script> 时，这一操作相当于x&gt;&gt;n；而当 <script type="math/tex">x<0</script> 时，若直接对原数右移n位，相当于 <script type="math/tex">\lfloor \frac{x}{2^n} \rfloor</script>，并不满足向0取整的要求。而对于整数，有如下定理成立：</p>
<blockquote>
<p>对于整数 <script type="math/tex">x</script> 和 <script type="math/tex">y(y>0)</script>，有 <script type="math/tex">\lceil \frac{x}{y} \rceil = \lfloor \frac{x+y-1}{y} \rfloor</script></p>
</blockquote>
<p>由此可知对于负数，我们只需将其加上一个偏置 <script type="math/tex">2^n -1</script>，即可将结果变为向上取整。因此当 <script type="math/tex">x<0</script> 时的操作为 <script type="math/tex">(x+(1<<n)-1)>>n</script>。</p>
<p>现在我们要通过位运算将这两种情况整合到一起。通过观察可以发现，我们只需要让某个运算在 <script type="math/tex">x \geq 0</script> 时的结果为0，在 <script type="math/tex">x < 0</script> 时的结果为(1&lt;&lt;n)-1即可。同样的，我们可以使用掩码的思想来做到这一点。结合补码的性质及算数右移的性质，我们可以发现只需要将x右移31位即可得到掩码。由此最终的运算操作也迎刃而解。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">divpwr2</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> tn = ~((~<span class="number">0</span>)&lt;&lt;n);</span><br><span class="line">    <span class="keyword">int</span> tx = (~((x&gt;&gt;<span class="number">31</span>) &amp; <span class="number">0x01</span>)) + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> (x + (tx &amp; tn)) &gt;&gt; n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="isPositive"><a href="#isPositive" class="headerlink" title="isPositive"></a>isPositive</h3><p>根据题意，我们要让大于0的数运算结果等于1，0和小于0的数运算结果等于0。根据补码的性质，对于除0以外的其他数，我们只需判断最高位是否为1即可；而对于0，我们可以将其单独讨论。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">isPositive</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> tx = (x&gt;&gt;<span class="number">31</span>) &amp; <span class="number">0x01</span>;</span><br><span class="line">	<span class="keyword">return</span> !(tx | !x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="isLessOrEqual"><a href="#isLessOrEqual" class="headerlink" title="isLessOrEqual"></a>isLessOrEqual</h3><p>当两数异号时，如果直接相减可能会导致结果溢出，但此时我们仅需判断其中一个数的正负即可得知结果，因此无需做减法运算；而当两个数同号时，可以保证相减不会溢出，因此我们只需相减判断符号即可。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">isLessOrEqual</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> negx = ~x + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">int</span> addx = negx + y;</span><br><span class="line">  <span class="keyword">int</span> sign = addx&gt;&gt;<span class="number">31</span>&amp;<span class="number">1</span>;</span><br><span class="line">  <span class="keyword">int</span> left = <span class="number">1</span>&lt;&lt;<span class="number">31</span>;</span><br><span class="line">  <span class="keyword">int</span> xleft = x &amp; left;</span><br><span class="line">  <span class="keyword">int</span> yleft = y &amp; left;</span><br><span class="line">  <span class="keyword">int</span> <span class="keyword">xor</span> = xleft ^ yleft;</span><br><span class="line">  <span class="keyword">xor</span> = (<span class="keyword">xor</span> &gt;&gt; <span class="number">31</span>) &amp; <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> ((!<span class="keyword">xor</span>)&amp;(!sign))|(<span class="keyword">xor</span>&amp;(xleft&gt;&gt;<span class="number">31</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ilog2"><a href="#ilog2" class="headerlink" title="ilog2"></a>ilog2</h3><p>根据二进制的性质，我们只需要找到最高1的位置即可。仿照前面统计1的个数的思想，我们可以使用二分法来解决这一问题。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ilog2</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> t1, t2, t3;</span><br><span class="line">	t3 = x;</span><br><span class="line">	t2 = (!!(t3&gt;&gt;<span class="number">16</span>))&lt;&lt;<span class="number">4</span>;</span><br><span class="line">	t3 = t3&gt;&gt;t2;</span><br><span class="line">	t1 = (!!(t3&gt;&gt;<span class="number">8</span>))&lt;&lt;<span class="number">3</span>;</span><br><span class="line">	t3 = t3&gt;&gt;t1;</span><br><span class="line">	t2 = t2 | t1;</span><br><span class="line">	t1 = (!!(t3&gt;&gt;<span class="number">4</span>))&lt;&lt;<span class="number">2</span>;</span><br><span class="line">	t3 = t3&gt;&gt;t1;</span><br><span class="line">	t2 = t2 | t1;</span><br><span class="line">	t1 = (!!(t3&gt;&gt;<span class="number">2</span>))&lt;&lt;<span class="number">1</span>;</span><br><span class="line">	t3 = t3&gt;&gt;t1;</span><br><span class="line">	t2 = t2 | t1;</span><br><span class="line">	<span class="keyword">return</span> (t2 | (t3&gt;&gt;<span class="number">1</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="float-neg"><a href="#float-neg" class="headerlink" title="float_neg"></a>float_neg</h3><p>在IEEE标准下，float型的格式为1位符号位，8位指数位和23位尾数位。因此我们首先要判断输入的数能否表示为一个float型小数。具体的，我们只需要将其符号位去除（左移），随后将其与0xFF000000比较即可。若大于这个数，则表明其不能表示为float型小数；若小于等于这个数，只需要改变其符号位即可得到结果。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="title">float_neg</span><span class="params">(<span class="keyword">unsigned</span> uf)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> x = <span class="number">0x80000000</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> c = <span class="number">0xFF000000</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> tuf = uf&lt;&lt;<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span>((c &amp; tuf) == c)&#123;</span><br><span class="line">		<span class="keyword">if</span>(tuf != c) <span class="keyword">return</span> uf;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> uf ^ x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="float-i2f"><a href="#float-i2f" class="headerlink" title="float_i2f"></a>float_i2f</h3><p>根据IEEE标准中float型的规则，我们需要先计算出符号尾及指数位的数值。随后，我们仅需利用位移操作将符号位、指数位、尾数位移动到相应的位置，再根据舍入的规则做一次微调即可。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="title">float_i2f</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> ax, sign, flag, tmp, shift, cur;</span><br><span class="line">	ax = x;</span><br><span class="line">	sign = x &amp; (<span class="number">1</span>&lt;&lt;<span class="number">31</span>);</span><br><span class="line">	<span class="keyword">if</span>(sign) ax = -x;</span><br><span class="line">	shift = ax;</span><br><span class="line">	<span class="keyword">if</span>(!x) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	cur = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">		tmp = shift;</span><br><span class="line">		shift = shift&lt;&lt;<span class="number">1</span>;</span><br><span class="line">		cur++;</span><br><span class="line">		<span class="keyword">if</span>(tmp &amp; <span class="number">0x80000000</span>) <span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>((shift &amp; <span class="number">0x01FF</span>) &gt; <span class="number">0x0100</span>) flag = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>((shift &amp; <span class="number">0x03FF</span>) == <span class="number">0x0300</span>) flag = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">else</span> flag = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">return</span> sign + ((<span class="number">159</span> - cur)&lt;&lt;<span class="number">23</span>) + (shift&gt;&gt;<span class="number">9</span>) + flag;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="float-twice"><a href="#float-twice" class="headerlink" title="float_twice"></a>float_twice</h3><p>在二进制科学技术法下，对某个数x乘以2就相对于将其阶数加一。因此若原数阶码不为0且不为255，则直接将阶码加一即可。若阶码等于0，表明其为非规范化数，因此直接将尾数位左移一位即可。由于非规范化数与规范化数之间有一个平滑过渡关系，因此即使左移一位后尾数位的最高位移动至了阶码位，该操作仍然是合法的。当原数阶码为255时，表明其为 <script type="math/tex">\infty</script> 或 <script type="math/tex">NaN</script>，不能进行算术运算，直接返回即可。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="title">float_twice</span><span class="params">(<span class="keyword">unsigned</span> uf)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>((uf &amp; <span class="number">0x7F800000</span>) == <span class="number">0</span>)</span><br><span class="line">		uf = ((uf &amp; <span class="number">0x007FFFFF</span>) &lt;&lt; <span class="number">1</span>) | (uf &amp; <span class="number">0x80000000</span>);</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>((uf &amp; <span class="number">0x7F800000</span>) != <span class="number">0x7F800000</span>)</span><br><span class="line">		uf = uf + <span class="number">0x800000</span>;</span><br><span class="line">	<span class="keyword">return</span> uf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>GONGGONGJOHN
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://gonggongjohn.me/2021/01/30/csapp-datalab/" title="Data Lab实验记录">http://gonggongjohn.me/2021/01/30/csapp-datalab/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Computer-Science/" rel="tag"># Computer-Science</a>
              <a href="/tags/Computer-System/" rel="tag"># Computer-System</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/01/30/csapp-malloclab/" rel="prev" title="Malloc Lab实验记录">
      <i class="fa fa-chevron-left"></i> Malloc Lab实验记录
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A6%82%E8%BF%B0"><span class="nav-number">1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0"><span class="nav-number">2.</span> <span class="nav-text">具体实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#bitAnd"><span class="nav-number">2.1.</span> <span class="nav-text">bitAnd</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#getByte"><span class="nav-number">2.2.</span> <span class="nav-text">getByte</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#logicalShift"><span class="nav-number">2.3.</span> <span class="nav-text">logicalShift</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bitCount"><span class="nav-number">2.4.</span> <span class="nav-text">bitCount</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#negate"><span class="nav-number">2.5.</span> <span class="nav-text">negate</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bang"><span class="nav-number">2.6.</span> <span class="nav-text">bang</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tmin"><span class="nav-number">2.7.</span> <span class="nav-text">tmin</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fitsBits"><span class="nav-number">2.8.</span> <span class="nav-text">fitsBits</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#divpwr2"><span class="nav-number">2.9.</span> <span class="nav-text">divpwr2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#isPositive"><span class="nav-number">2.10.</span> <span class="nav-text">isPositive</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#isLessOrEqual"><span class="nav-number">2.11.</span> <span class="nav-text">isLessOrEqual</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ilog2"><span class="nav-number">2.12.</span> <span class="nav-text">ilog2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#float-neg"><span class="nav-number">2.13.</span> <span class="nav-text">float_neg</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#float-i2f"><span class="nav-number">2.14.</span> <span class="nav-text">float_i2f</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#float-twice"><span class="nav-number">2.15.</span> <span class="nav-text">float_twice</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="GONGGONGJOHN"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">GONGGONGJOHN</p>
  <div class="site-description" itemprop="description">A sophomore student major in Data Science.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">14</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/gonggongjohn" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;gonggongjohn" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2020 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">GONGGONGJOHN</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
          load: ['[tex]/mhchem'],
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
          packages: {'[+]': ['mhchem']},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

</body>
</html>
